# IconTool 使用说明

> PNG/ICO 透明度检测与透明化命令行工具

---

## 一、项目概述

IconTool 是一个独立的命令行工具，提供三大核心功能：

1. **自动模式**（无参数）— 扫描当前目录图片，自动检测→透明化→生成 ICO，一键完成
2. **check** — 检测 PNG 或 ICO 文件是否真的包含透明通道，并给出详细分析报告
3. **transparent** — 将图片中的指定背景色去除，输出为带透明通道的 PNG

技术栈：.NET 10 + SixLabors.ImageSharp，支持发布为 Windows 单文件可执行程序（无需安装 .NET 运行时）。

> **注意**：主项目 `TranslationToolUI.csproj` 中的 `GenerateAppIconIco` Target（原 IconGen 自动构建）已禁用。图标生成改为通过 IconTool 手动执行。如需恢复自动构建，移除 csproj 中 Target 的 `Condition="false"`。

---

## 二、编译与打包

### 前置条件

- 已安装 [.NET 10 SDK](https://dotnet.microsoft.com/download)（或更高版本）
- Windows x64 环境（发布产物默认为 win-x64）

### 编译（开发调试）

在 `tools/IconTool` 目录下执行：

```powershell
dotnet build
```

产物位于 `bin/Debug/net10.0/win-x64/`，需要本机安装 .NET 运行时才能运行。

### 发布为单文件可执行程序（推荐）

```powershell
dotnet publish -c Release
```

产物位于 `bin/Release/net10.0/win-x64/publish/`，生成的 `IconTool.exe`（约 15 MB）是自包含的单文件程序，可直接复制到任何 Windows x64 机器上运行，**无需安装 .NET 运行时**。

### 发布说明

项目 `.csproj` 已预配置以下发布参数：

| 参数 | 值 | 说明 |
|------|-----|------|
| `PublishSingleFile` | `true` | 打包为单个 EXE |
| `SelfContained` | `true` | 包含 .NET 运行时，无需目标机器安装 |
| `RuntimeIdentifier` | `win-x64` | 目标平台为 Windows x64 |
| `PublishTrimmed` | `true` | 裁剪未使用的程序集，减小体积 |

如需发布到其他平台（如 linux-x64），可修改 `RuntimeIdentifier` 或在命令行覆盖：

```powershell
dotnet publish -c Release -r linux-x64
```

---

## 三、使用方法

### 查看帮助

```powershell
IconTool help
IconTool --help
IconTool -h
```

---

### 自动模式（无参数）— 一键处理当前目录

#### 用法

直接运行 `IconTool`，不带任何参数：

```powershell
# 将 IconTool.exe 复制到包含图片的目录，然后双击运行或在终端执行：
IconTool
```

#### 处理流程

工具会自动对当前目录中所有 `*.png`、`*.jpg`、`*.jpeg` 文件执行以下流程：

```
扫描当前目录图片
  ↓
逐个文件处理：
  ├─ 已透明？ → 跳过透明化（仍会生成 ICO）
  ├─ 四周为白色？ → 去白色背景
  ├─ 四周为黑色？ → 去黑色背景
  └─ 四周颜色混杂？ → 跳过（不适合自动处理）
  ↓
透明化后覆盖原文件（JPG 自动转为 PNG）
  ↓
生成同名 .ico（16/32/48/256 四尺寸）
  ↓
源文件（含旧 .ico）备份到时间子目录
  ↓
输出详细处理日志
```

#### 背景色自动检测

工具会对图像**四条边**进行均匀采样（每边约 40 个采样点），统计边缘像素的颜色分布：

| 条件 | 判定 |
|------|------|
| ≥85% 边缘像素接近白色 (RGB≥225) | 背景色 = white |
| ≥85% 边缘像素接近黑色 (RGB≤30) | 背景色 = black |
| 其他情况 | 颜色不一致，跳过该文件 |

#### 备份与日志

每次运行会在当前目录创建一个以时间命名的备份子目录：

```
backup_20260220_153045/
  ├── AppIcon.png          ← 原始 PNG 备份
  ├── AppIcon.ico          ← 原始 ICO 备份（如果已存在）
  ├── banner.jpg           ← 原始 JPG 备份
  └── 处理日志.txt          ← 详细处理日志
```

#### 日志示例

```
IconTool 自动处理日志
处理时间: 2026-02-20 15:30:45
工作目录: C:\icons
备份目录: C:\icons\backup_20260220_153045
待处理文件数: 3
────────────────────────────────────────────────────────────

[文件] logo.png
  尺寸: 512x512
  检测到背景色: white (R=255, G=255, B=255)
  备份源文件: logo.png → logo.png
  透明化像素: 45320/262144 (17.29%)
  输出文件: logo.png (198.5 KB)
  备份已有 ICO: logo.ico → logo.ico
  生成 ICO: logo.ico (91.0 KB, 尺寸: 16/32/48/256)
  结果: 成功

[文件] photo.jpg
  尺寸: 800x600
  结果: 跳过 — 四周像素颜色不一致，无法确定单一背景色

[文件] icon.png
  尺寸: 256x256
  结果: 跳过 — 已是透明图片（透明像素=12000, 占比=18.31%）
  生成 ICO: icon.ico (85.2 KB, 尺寸: 16/32/48/256)

════════════════════════════════════════════════════════════
汇总: 共 3 个文件, 成功 1, 跳过 2, 失败 0
```

#### ICO 生成说明

自动模式下生成的 ICO 与原 IconGen 工具逻辑一致：

- 图像先补齐为正方形（透明填充），保持比例
- 生成 4 个尺寸：16×16、32×32、48×48、256×256
- 使用 PNG 格式嵌入 ICO（现代标准）
- 如果目录已有同名 `.ico`，先备份再覆盖

#### 典型使用场景

```powershell
# 场景1：批量处理一批应用图标
cd C:\my-icons
IconTool

# 场景2：把 IconTool.exe 放到 PATH 中，随时在任何目录使用
$env:PATH += ";C:\tools"
cd C:\项目\Assets
IconTool

# 场景3：处理完后检查某个文件的效果
IconTool check logo.png
```

---

### 命令一：`check` — 透明度检测

#### 用法

```
IconTool check <文件路径>
```

支持 `.png` 和 `.ico` 两种格式。

#### 示例

```powershell
# 检测一张 PNG 图片
IconTool check logo.png

# 检测一个 ICO 图标文件
IconTool check "C:\icons\app.ico"
```

#### 输出内容说明

执行后会输出以下详细报告：

**1）基本统计**

```
尺寸: 448x448
总像素: 200,704
完全透明像素 (A=0): 37,245 (18.56%)
半透明像素 (0<A<255): 3,638 (1.81%)
包含透明通道: 是
```

- **完全透明像素 (A=0)**：Alpha 值为 0 的像素数量和占比
- **半透明像素 (0<A<255)**：Alpha 值介于 1~254 的像素数量和占比（常见于边缘抗锯齿）
- **包含透明通道**：只要存在任何非 255 的 Alpha 值，即判定为"是"

**2）角点检测**

```
■ 角点检测:
  左上       (   0,   0) A=  0 RGB=(0,0,0) → 透明
  右上       ( 447,   0) A=  0 RGB=(0,0,0) → 透明
  左下       (   0, 447) A=  0 RGB=(0,0,0) → 透明
  右下       ( 447, 447) A=  0 RGB=(0,0,0) → 透明
  左上(内)   (  20,  20) A=  0 RGB=(0,0,0) → 透明
  右上(内)   ( 427,  20) A=  0 RGB=(0,0,0) → 透明
  左下(内)   (  20, 427) A=  0 RGB=(0,0,0) → 透明
  右下(内)   ( 427, 427) A=  0 RGB=(0,0,0) → 透明
```

- 检测图像四个角落以及内缩的近角点（向内偏移 `min(20px, 图像边长的 10%)`）
- 用于判断图标是否为"圆角透明"样式

**3）主体区域采样**

```
■ 主体区域采样:
  ( 224, 224) A=255 RGB=(209,227,251) → 不透明
  ( 112, 112) A=255 RGB=(121,218,250) → 不透明
  ...
```

- 对图像中心及四个象限的中心点进行采样
- 确认主体图案是否为不透明（避免整图被误判为"透明"）

**4）综合判定**

```
■ 判定结果:
  ✓ 圆角透明图标 — 四角透明且主体不透明。
```

判定结果有三种：

| 结果 | 含义 |
|------|------|
| `✓ 圆角透明图标` | 四角和近角点全部透明，主体区域不透明。标准圆角图标。 |
| `△ 含透明通道` | 有透明像素，但四角不全透明，或主体区域存在半透明。需要进一步检查。 |
| `✗ 不透明图片` | 没有任何透明像素，图片完全不透明。 |

#### ICO 文件特殊行为

对于 `.ico` 文件，工具会解析 ICO 内部结构，**逐一分析每张嵌入图像**：

```
── 检测 ICO: AppIcon.ico ──

ICO 包含 4 张嵌入图像

  [图像 1] 16x16, 数据大小=827 字节
    尺寸: 16x16
    总像素: 256
    ...（完整报告）

  [图像 2] 32x32, 数据大小=2544 字节
    ...

  [图像 3] 48x48, ...
  [图像 4] 256x256, ...
```

每张嵌入图像都会独立输出透明度分析报告和判定结果。

---

### 命令二：`transparent` — 背景透明化

#### 用法

```
IconTool transparent <文件路径> [选项]
```

支持输入 PNG、JPG、JPEG 等 ImageSharp 支持的常见图片格式，输出始终为 PNG。

#### 选项

| 选项 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--output <路径>` | `-o` | `原文件名_transparent.png` | 输出文件路径 |
| `--color <颜色>` | `-c` | `white` | 要去除的背景色 |
| `--threshold <值>` | `-t` | `30` | 颜色匹配容差（0-255） |

**颜色值支持格式：**

| 格式 | 示例 | 说明 |
|------|------|------|
| 预设名称 | `white`、`black` | 白色或黑色 |
| 十六进制 RGB | `#FF0000` | 红色 |
| 十六进制 RGBA | `#FF000080` | 半透明红色 |

#### 示例

```powershell
# 去除白色背景（默认），输出为 photo_transparent.png
IconTool transparent photo.png

# 去除白色背景，指定输出文件名
IconTool transparent photo.jpg -o clean.png

# 去除红色背景
IconTool transparent banner.png -c "#FF0000"

# 去除黑色背景，加大容差
IconTool transparent dark_logo.png -c black -t 50

# 去除特定颜色背景
IconTool transparent card.png -c "#F0F0F0" -t 20 -o card_clean.png
```

#### 输出内容说明

执行后会输出处理过程和结果：

```
── 透明化处理 ──
  输入: photo.png
  去除背景色: white (R=255, G=255, B=255)
  颜色容差: 30
  输出: photo_transparent.png

  图像尺寸: 448x448
  已透明化像素: 15819/200704 (7.88%)
  输出文件大小: 198.3 KB
```

- **已透明化像素**：被去除背景色后变为透明的像素数量和占比
- **输出文件大小**：最终 PNG 文件的大小

处理完成后，工具会**自动对输出文件执行一次透明度检测**，输出与 `check` 命令相同的详细报告，方便验证效果。

#### 透明化算法说明

工具采用两级处理策略：

1. **完全匹配区域**：像素与目标背景色的 R/G/B 各通道差值均在容差 (`threshold`) 范围内时，该像素被设置为**完全透明** (A=0)
2. **边缘渐变过渡**：像素与目标色的欧氏距离在 `threshold` ~ `threshold×2` 范围内时，Alpha 值会按距离比例渐变，避免边缘出现生硬锯齿

**容差参数调节建议：**

| 容差值 | 适用场景 |
|--------|----------|
| `0-10` | 背景色非常精确且均匀（如纯白 #FFFFFF） |
| `20-40` | 一般场景（默认 30），适用于大多数纯色背景 |
| `50-80` | 背景色存在轻微渐变或噪点 |
| `>100` | 谨慎使用，可能误伤主体颜色 |

---

## 四、退出码

| 退出码 | 含义 |
|--------|------|
| `0` | 成功 |
| `1` | 参数错误或处理失败 |

---

## 五、常见问题

### Q: JPG/JPEG 可以检测透明度吗？

JPG 格式本身不支持透明通道，`check` 命令只支持 `.png` 和 `.ico`。但 `transparent` 命令可以接受 JPG 作为输入，去除背景色后输出为 PNG。

### Q: 路径中包含空格或中文怎么办？

用双引号包裹路径即可：

```powershell
IconTool check "C:\我的图片\应用图标.png"
```

### Q: 输出的 PNG 透明后背景变成黑色？

这不是工具的问题，是图片查看器的显示行为。部分查看器在透明区域显示黑色或灰色棋盘格。可以用支持透明的查看器（如 Windows 照片、浏览器）验证。

### Q: 怎样确认透明化效果是否满意？

`transparent` 命令执行后会自动运行 `check` 检测。重点关注：
- **判定结果**是否符合预期
- **主体区域采样**中主体是否仍为不透明 (A=255)
- **透明像素占比**是否合理

如果主体像素被误伤（出现半透明），尝试降低容差值 (`-t`)。

### Q: 自动模式下 JPG 文件会怎样处理？

JPG 不支持透明通道。工具会将透明化后的结果保存为同名 `.png` 文件，原 JPG 备份到时间子目录后删除。

### Q: 自动模式跳过了文件怎么办？

查看备份目录下的 `处理日志.txt`，会记录每个文件被跳过的具体原因（已透明/颜色不一致）。如果需要强制处理，可以用 `transparent` 命令手动指定颜色：

```powershell
IconTool transparent myfile.png -c "#F0F0F0" -t 40 -o myfile.png
```

### Q: IconGen 和 IconTool 有什么关系？

IconGen 是原有的构建时自动图标生成工具（`tools/IconGen`），仅做 `PNG → ICO` 转换。IconTool 是增强版独立工具，集成了透明度检测、背景透明化、ICO 生成三合一功能。主项目构建中的 IconGen 自动步骤已禁用，改用 IconTool 手动处理。
