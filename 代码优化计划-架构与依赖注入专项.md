# ä»£ç ä¼˜åŒ–è®¡åˆ’-æ¶æ„ä¸ä¾èµ–æ³¨å…¥ä¸“é¡¹

> æœ¬æ–‡æ˜¯ [ä»£ç ä¼˜åŒ–è®¡åˆ’.md](ä»£ç ä¼˜åŒ–è®¡åˆ’.md) çš„è¡¥å……æ–‡æ¡£ï¼Œä¸“é—¨é’ˆå¯¹ä¾èµ–æ³¨å…¥å®¹å™¨å¼•å…¥ã€æœåŠ¡æ¥å£æå–ã€ViewModel ä¸ View è§£è€¦æä¾›è¯¦ç»†çš„å®æ–½æ–¹æ¡ˆã€‚

---

## ç›®å½•

1. [ä¾èµ–æ³¨å…¥å®¹å™¨å®Œæ•´è¿ç§»æ–¹æ¡ˆ](#1-ä¾èµ–æ³¨å…¥å®¹å™¨å®Œæ•´è¿ç§»æ–¹æ¡ˆ)
2. [æœåŠ¡æ¥å£æå–è¯¦ç»†æ–¹æ¡ˆ](#2-æœåŠ¡æ¥å£æå–è¯¦ç»†æ–¹æ¡ˆ)
3. [ViewModel ä¸ View è§£è€¦æ–¹æ¡ˆ](#3-viewmodel-ä¸-view-è§£è€¦æ–¹æ¡ˆ)
4. [æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†](#4-æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†)
5. [ç›®å½•ç»“æ„é‡ç»„å»ºè®®](#5-ç›®å½•ç»“æ„é‡ç»„å»ºè®®)

---

## 1. ä¾èµ–æ³¨å…¥å®¹å™¨å®Œæ•´è¿ç§»æ–¹æ¡ˆ

### 1.1 å½“å‰ä¾èµ–å…³ç³»å›¾

```
MainWindowViewModel
â”œâ”€â”€ new ConfigurationService()
â”œâ”€â”€ new AzureTokenProvider()
â”œâ”€â”€ new AiInsightService(tokenProvider)
â”œâ”€â”€ new SpeechTranslationService(config, tokenProvider, ...)
â”œâ”€â”€ new FloatingSubtitleManager()
â”œâ”€â”€ new AudioDeviceEnumerator()
â”œâ”€â”€ AzureSpeechConfig (loaded from ConfigurationService)
â””â”€â”€ (é—´æ¥) new SpeechBatchApiClient()

MediaStudioViewModel
â”œâ”€â”€ new AiImageGenService(config, tokenProvider)
â”œâ”€â”€ new AiVideoGenService(config, tokenProvider)
â””â”€â”€ MediaGenConfig (from AzureSpeechConfig)

FloatingSubtitleViewModel
â””â”€â”€ (è½»é‡, æ— æœåŠ¡ä¾èµ–)
```

### 1.2 å®Œæ•´ DI é…ç½®

```csharp
// App.axaml.cs
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

public partial class App : Application
{
    public static IServiceProvider Services { get; private set; } = null!;

    public override void OnFrameworkInitializationCompleted()
    {
        var services = new ServiceCollection();
        ConfigureServices(services);
        Services = services.BuildServiceProvider();

        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            var mainViewModel = Services.GetRequiredService<MainWindowViewModel>();
            desktop.MainWindow = new MainWindow
            {
                DataContext = mainViewModel
            };

            // è®¾ç½® DialogServiceï¼ˆéœ€è¦ Window å¼•ç”¨ï¼‰
            var dialogService = new DialogService(desktop.MainWindow);
            mainViewModel.SetDialogService(dialogService);
        }

        base.OnFrameworkInitializationCompleted();
    }

    private static void ConfigureServices(IServiceCollection services)
    {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æ—¥å¿—
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddLogging(builder =>
        {
            builder.SetMinimumLevel(LogLevel.Information);
            builder.AddDebug();
#if DEBUG
            builder.SetMinimumLevel(LogLevel.Debug);
#endif
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // åŸºç¡€æœåŠ¡ï¼ˆSingleton - å…¨å±€å”¯ä¸€ï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddSingleton<PathManager>();
        services.AddSingleton<AppLogService>();
        services.AddSingleton<CrashLogger>();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é…ç½®ä¸è®¤è¯ï¼ˆSingletonï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddSingleton<IConfigurationService, ConfigurationService>();
        services.AddSingleton<IAzureTokenProvider, AzureTokenProvider>();
        services.AddSingleton<AzureSubscriptionValidator>();

        // é…ç½®å¯¹è±¡ï¼ˆä»æœåŠ¡åŠ è½½ï¼‰
        services.AddSingleton(sp =>
        {
            var configService = sp.GetRequiredService<IConfigurationService>();
            return configService.Load();
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼ˆSingleton - çŠ¶æ€åŒ–ï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddSingleton<ISpeechTranslationService, SpeechTranslationService>();
        services.AddSingleton<IAiInsightService, AiInsightService>();
        services.AddSingleton<ISpeechBatchApiClient, SpeechBatchApiClient>();
        services.AddSingleton<SubtitleSyncService>();
        services.AddSingleton<SubtitleFileParser>();
        services.AddSingleton<BatchTranscriptionParser>();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // å·¥å…·æœåŠ¡ï¼ˆTransient - æ— çŠ¶æ€ï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddTransient<AudioFormatConverter>();
        services.AddTransient<ImageCropService>();
        services.AddTransient<VideoFrameExtractorService>();
        services.AddTransient<BlobStorageService>();
        services.AddTransient<MarkdownContentLoader>();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // åª’ä½“ç”ŸæˆæœåŠ¡ï¼ˆTransient - æŒ‰éœ€åˆ›å»ºï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddTransient<AiImageGenService>();
        services.AddTransient<AiVideoGenService>();
        services.AddTransient<VideoCapabilityResolver>();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // éŸ³é¢‘æœåŠ¡ï¼ˆSingleton - è®¾å¤‡ç»‘å®šï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddSingleton<AudioDeviceEnumerator>();
        services.AddSingleton<FloatingSubtitleManager>();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ViewModelï¼ˆTransientï¼‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        services.AddTransient<MainWindowViewModel>();
        services.AddTransient<MediaStudioViewModel>();
        services.AddTransient<FloatingSubtitleViewModel>();
        services.AddTransient<ReferenceImageCropViewModel>();
    }
}
```

### 1.3 ViewModel æ„é€ å‡½æ•°æ”¹é€ 

**MainWindowViewModel.cs**

```csharp
// âŒ æ”¹é€ å‰
public partial class MainWindowViewModel : ViewModelBase
{
    private readonly ConfigurationService _configService;
    private readonly AzureTokenProvider _azureTokenProvider;
    private readonly AiInsightService _aiInsightService;
    // ... æ›´å¤šç§æœ‰å­—æ®µ

    public MainWindowViewModel()
    {
        _configService = new ConfigurationService();
        _azureTokenProvider = new AzureTokenProvider();
        _aiInsightService = new AiInsightService(_azureTokenProvider);
        _config = _configService.Load();
        // ... æ›´å¤šåˆå§‹åŒ–
    }
}

// âœ… æ”¹é€ å
public partial class MainWindowViewModel : ViewModelBase
{
    private readonly IConfigurationService _configService;
    private readonly IAzureTokenProvider _azureTokenProvider;
    private readonly IAiInsightService _aiInsightService;
    private readonly ISpeechTranslationService _speechTranslationService;
    private readonly ISpeechBatchApiClient _batchApiClient;
    private readonly FloatingSubtitleManager _floatingSubtitleManager;
    private readonly AudioDeviceEnumerator _audioDeviceEnumerator;
    private readonly ILogger<MainWindowViewModel> _logger;
    private IDialogService? _dialogService;

    public MainWindowViewModel(
        IConfigurationService configService,
        IAzureTokenProvider azureTokenProvider,
        IAiInsightService aiInsightService,
        ISpeechTranslationService speechTranslationService,
        ISpeechBatchApiClient batchApiClient,
        FloatingSubtitleManager floatingSubtitleManager,
        AudioDeviceEnumerator audioDeviceEnumerator,
        AzureSpeechConfig config,
        ILogger<MainWindowViewModel> logger)
    {
        _configService = configService;
        _azureTokenProvider = azureTokenProvider;
        _aiInsightService = aiInsightService;
        _speechTranslationService = speechTranslationService;
        _batchApiClient = batchApiClient;
        _floatingSubtitleManager = floatingSubtitleManager;
        _audioDeviceEnumerator = audioDeviceEnumerator;
        _config = config;
        _logger = logger;

        InitializeCommands();
        InitializeCollections();
    }

    // DialogService éœ€è¦ Window å¼•ç”¨ï¼Œæ‰€ä»¥åè®¾ç½®
    public void SetDialogService(IDialogService dialogService)
        => _dialogService = dialogService;
}
```

**MediaStudioViewModel.cs**

```csharp
// âœ… æ”¹é€ å
public partial class MediaStudioViewModel : ViewModelBase
{
    private readonly AiImageGenService _imageGenService;
    private readonly AiVideoGenService _videoGenService;
    private readonly ILogger<MediaStudioViewModel> _logger;

    public MediaStudioViewModel(
        AiImageGenService imageGenService,
        AiVideoGenService videoGenService,
        AzureSpeechConfig config,
        ILogger<MediaStudioViewModel> logger)
    {
        _imageGenService = imageGenService;
        _videoGenService = videoGenService;
        _config = config;
        _logger = logger;
    }
}
```

### 1.4 æ¸è¿›å¼è¿ç§»ç­–ç•¥

ä¸éœ€è¦ä¸€æ¬¡æ€§æ”¹å®Œæ‰€æœ‰ä»£ç ã€‚æ¨èä»¥ä¸‹é¡ºåºï¼š

```
ç¬¬ 1 æ­¥: å®‰è£… DI åŒ… + åœ¨ App.axaml.cs ä¸­åˆ›å»ºå®¹å™¨
         â†“
ç¬¬ 2 æ­¥: å…ˆåªæ³¨å†Œ MainWindowViewModelï¼ˆä¿æŒå†…éƒ¨ new()ï¼‰
         â†“
ç¬¬ 3 æ­¥: é€ä¸ªæœåŠ¡è¿ç§»ï¼ˆæ¯æ¬¡æå–ä¸€ä¸ªæ¥å£ + æ³¨å†Œåˆ°å®¹å™¨ï¼‰
         â†“
ç¬¬ 4 æ­¥: æœ€åæ¸…ç† ViewModel ä¸­æ®‹ç•™çš„ new() è°ƒç”¨
```

**å…¼å®¹ä¸­é—´çŠ¶æ€çš„æŠ€å·§ï¼š**

```csharp
// åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åŒæ—¶æ”¯æŒ DI å’Œæ‰‹åŠ¨åˆ›å»º
public MainWindowViewModel() : this(
    new ConfigurationService(),
    new AzureTokenProvider(),
    // ... é»˜è®¤å€¼
    NullLogger<MainWindowViewModel>.Instance)
{ }

public MainWindowViewModel(
    IConfigurationService configService,
    IAzureTokenProvider tokenProvider,
    // ... é€šè¿‡ DI æ³¨å…¥
    ILogger<MainWindowViewModel> logger)
{
    _configService = configService;
    // ...
}
```

---

## 2. æœåŠ¡æ¥å£æå–è¯¦ç»†æ–¹æ¡ˆ

### 2.1 ç¬¬ä¸€æ‰¹æ¥å£ï¼ˆé«˜ä¼˜å…ˆçº§ - å½±å“å¯æµ‹è¯•æ€§ï¼‰

#### IConfigurationService

```csharp
// Interfaces/IConfigurationService.cs
namespace TrueFluentPro.Interfaces;

public interface IConfigurationService
{
    /// <summary>åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤é…ç½®</summary>
    AzureSpeechConfig Load();

    /// <summary>ä¿å­˜é…ç½®åˆ°ç£ç›˜</summary>
    void Save(AzureSpeechConfig config);

    /// <summary>è·å–é…ç½®æ–‡ä»¶è·¯å¾„</summary>
    string ConfigFilePath { get; }
}
```

#### IAzureTokenProvider

```csharp
// Interfaces/IAzureTokenProvider.cs
namespace TrueFluentPro.Interfaces;

public interface IAzureTokenProvider
{
    /// <summary>è·å–æŒ‡å®šèµ„æºçš„è®¿é—®ä»¤ç‰Œ</summary>
    Task<string> GetTokenAsync(string resource, CancellationToken ct = default);

    /// <summary>å°è¯•é™é»˜ç™»å½•ï¼ˆä½¿ç”¨ç¼“å­˜çš„ AuthRecordï¼‰</summary>
    Task<bool> TrySilentLoginAsync();

    /// <summary>å¯åŠ¨è®¾å¤‡ç ç™»å½•æµç¨‹</summary>
    Task<bool> DeviceCodeLoginAsync(string tenantId, string clientId,
        Action<string> onDeviceCode, CancellationToken ct = default);

    /// <summary>æ˜¯å¦å·²ç™»å½•</summary>
    bool IsAuthenticated { get; }
}
```

#### ISpeechTranslationService

```csharp
// Interfaces/ISpeechTranslationService.cs
namespace TrueFluentPro.Interfaces;

public interface ISpeechTranslationService : IDisposable
{
    /// <summary>å¯åŠ¨å®æ—¶ç¿»è¯‘</summary>
    Task StartTranslationAsync(
        AzureSubscription subscription,
        string sourceLanguage,
        string targetLanguage,
        AudioSourceMode audioMode,
        CancellationToken ct = default);

    /// <summary>åœæ­¢ç¿»è¯‘</summary>
    Task StopTranslationAsync();

    /// <summary>å½“å‰æ˜¯å¦æ­£åœ¨ç¿»è¯‘</summary>
    bool IsTranslating { get; }

    /// <summary>æ”¶åˆ°ç¿»è¯‘ç»“æœæ—¶è§¦å‘</summary>
    event EventHandler<TranslationItem>? TranslationReceived;

    /// <summary>æ”¶åˆ°ä¸­é—´ç»“æœæ—¶è§¦å‘</summary>
    event EventHandler<string>? IntermediateResultReceived;

    /// <summary>ç¿»è¯‘ä¼šè¯é”™è¯¯æ—¶è§¦å‘</summary>
    event EventHandler<Exception>? TranslationError;
}
```

#### IAiInsightService

```csharp
// Interfaces/IAiInsightService.cs
namespace TrueFluentPro.Interfaces;

public interface IAiInsightService
{
    /// <summary>ä¸€æ¬¡æ€§è¿”å›åˆ†æç»“æœ</summary>
    Task<string> AnalyzeAsync(string content, string prompt,
        CancellationToken ct = default);

    /// <summary>æµå¼è¿”å›åˆ†æç»“æœï¼ˆç”¨äºå®æ—¶æ˜¾ç¤ºï¼‰</summary>
    Task StreamAnalyzeAsync(string content, string prompt,
        IProgress<string> progress, CancellationToken ct = default);

    /// <summary>ä½¿ç”¨è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¿›è¡Œåˆ†æ</summary>
    Task<string> AnalyzeWithSystemPromptAsync(string content,
        string systemPrompt, string userPrompt,
        CancellationToken ct = default);
}
```

#### ISpeechBatchApiClient

```csharp
// Interfaces/ISpeechBatchApiClient.cs
namespace TrueFluentPro.Interfaces;

public interface ISpeechBatchApiClient
{
    /// <summary>åˆ›å»ºæ‰¹é‡è½¬å†™ä»»åŠ¡</summary>
    Task<string> CreateTranscriptionAsync(string audioUrl, string locale,
        CancellationToken ct = default);

    /// <summary>æŸ¥è¯¢è½¬å†™ä»»åŠ¡çŠ¶æ€</summary>
    Task<BatchTaskStatus> GetStatusAsync(string transcriptionId,
        CancellationToken ct = default);

    /// <summary>è·å–è½¬å†™ç»“æœ</summary>
    Task<string> GetResultAsync(string transcriptionId,
        CancellationToken ct = default);

    /// <summary>åˆ é™¤è½¬å†™ä»»åŠ¡</summary>
    Task DeleteAsync(string transcriptionId,
        CancellationToken ct = default);
}
```

### 2.2 ç¬¬äºŒæ‰¹æ¥å£ï¼ˆä¸­ä¼˜å…ˆçº§ - æå‡çµæ´»æ€§ï¼‰

```csharp
// ä»¥ä¸‹æ¥å£å¯ä»¥åœ¨ç¬¬ä¸€æ‰¹ç¨³å®šåå†æå–

public interface IPathManager
{
    string AppDataDirectory { get; }
    string LogsDirectory { get; }
    string SessionsDirectory { get; }
    string GetSessionPath(string sessionId);
}

public interface IAudioFormatConverter
{
    Task ConvertWavToMp3Async(string inputPath, string outputPath,
        int bitrate = 128, CancellationToken ct = default);
}

public interface IBlobStorageService
{
    Task<string> UploadAsync(string containerName, string blobName,
        Stream content, CancellationToken ct = default);
    Task<Stream> DownloadAsync(string containerName, string blobName,
        CancellationToken ct = default);
}

public interface IFloatingSubtitleManager : IDisposable
{
    void Show();
    void Hide();
    void UpdateSubtitle(string text);
    bool IsVisible { get; }
}
```

### 2.3 æ¥å£æ–‡ä»¶ç»„ç»‡

```
TrueFluentPro/
â””â”€â”€ Interfaces/                    # æ–°å»ºç›®å½•
    â”œâ”€â”€ IConfigurationService.cs
    â”œâ”€â”€ IAzureTokenProvider.cs
    â”œâ”€â”€ ISpeechTranslationService.cs
    â”œâ”€â”€ IAiInsightService.cs
    â”œâ”€â”€ ISpeechBatchApiClient.cs
    â”œâ”€â”€ IDialogService.cs
    â”œâ”€â”€ IPathManager.cs            # ç¬¬äºŒæ‰¹
    â”œâ”€â”€ IAudioFormatConverter.cs   # ç¬¬äºŒæ‰¹
    â”œâ”€â”€ IBlobStorageService.cs     # ç¬¬äºŒæ‰¹
    â””â”€â”€ IFloatingSubtitleManager.cs # ç¬¬äºŒæ‰¹
```

---

## 3. ViewModel ä¸ View è§£è€¦æ–¹æ¡ˆ

### 3.1 IDialogService è¯¦ç»†è®¾è®¡

```csharp
// Interfaces/IDialogService.cs
namespace TrueFluentPro.Interfaces;

public interface IDialogService
{
    // â”€â”€â”€ é…ç½®å¯¹è¯æ¡† â”€â”€â”€
    Task<bool> ShowConfigCenterAsync(AzureSpeechConfig config);

    // â”€â”€â”€ Media Studio â”€â”€â”€
    Task ShowMediaStudioAsync();

    // â”€â”€â”€ æ–‡ä»¶é€‰æ‹© â”€â”€â”€
    Task<string?> OpenFileAsync(string title, IReadOnlyList<string> filters);
    Task<string[]?> OpenFilesAsync(string title, IReadOnlyList<string> filters);
    Task<string?> SaveFileAsync(string title, string defaultName,
        IReadOnlyList<string> filters);
    Task<string?> OpenFolderAsync(string title);

    // â”€â”€â”€ æ¶ˆæ¯æ¡† â”€â”€â”€
    Task ShowMessageAsync(string title, string message);
    Task<bool> ShowConfirmAsync(string title, string message);

    // â”€â”€â”€ å›¾ç‰‡é¢„è§ˆ â”€â”€â”€
    Task ShowImagePreviewAsync(string imagePath, string? title = null);

    // â”€â”€â”€ è£å‰ª â”€â”€â”€
    Task<string?> ShowImageCropAsync(string imagePath);

    // â”€â”€â”€ Tenant é€‰æ‹© â”€â”€â”€
    Task<string?> ShowTenantSelectionAsync(IReadOnlyList<AzureTenantInfo> tenants);
}
```

### 3.2 DialogService å®ç°

```csharp
// Services/DialogService.cs
namespace TrueFluentPro.Services;

public class DialogService : IDialogService
{
    private readonly Func<Window> _getOwner;

    public DialogService(Func<Window> getOwner)
    {
        _getOwner = getOwner;
    }

    public async Task<bool> ShowConfigCenterAsync(AzureSpeechConfig config)
    {
        var owner = _getOwner();
        var view = new ConfigCenterView(config);
        return await view.ShowDialog<bool>(owner);
    }

    public async Task ShowMediaStudioAsync()
    {
        var owner = _getOwner();
        var vm = App.Services.GetRequiredService<MediaStudioViewModel>();
        var window = new MediaStudioWindow { DataContext = vm };
        await window.ShowDialog(owner);
    }

    public async Task<string?> OpenFileAsync(string title,
        IReadOnlyList<string> filters)
    {
        var owner = _getOwner();
        var dialog = new OpenFileDialog
        {
            Title = title,
            Filters = filters.Select(f => new FileDialogFilter
            {
                Extensions = new List<string> { f }
            }).ToList()
        };
        var result = await dialog.ShowAsync(owner);
        return result?.FirstOrDefault();
    }

    public async Task ShowMessageAsync(string title, string message)
    {
        // ä½¿ç”¨ Avalonia çš„ Window æ¨¡æ‹Ÿæ¶ˆæ¯æ¡†
        // æˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¶ˆæ¯æ¡†ç»„ä»¶
        var msgWindow = new Window
        {
            Title = title,
            Width = 400,
            Height = 200,
            WindowStartupLocation = WindowStartupLocation.CenterOwner,
            Content = new StackPanel
            {
                Margin = new Thickness(20),
                Children =
                {
                    new TextBlock { Text = message, TextWrapping = TextWrapping.Wrap },
                    new Button
                    {
                        Content = "ç¡®å®š",
                        HorizontalAlignment = HorizontalAlignment.Center,
                        Margin = new Thickness(0, 20, 0, 0)
                    }
                }
            }
        };
        await msgWindow.ShowDialog(_getOwner());
    }

    public async Task<bool> ShowConfirmAsync(string title, string message)
    {
        // ç±»ä¼¼ ShowMessageAsyncï¼Œä½†æœ‰ ç¡®å®š/å–æ¶ˆ ä¸¤ä¸ªæŒ‰é’®
        // è¿”å›ç”¨æˆ·é€‰æ‹©
        // ...
        return true;
    }

    // ... å…¶ä½™æ–¹æ³•å®ç°ç±»ä¼¼
}
```

### 3.3 æ¶ˆé™¤ ViewModel ä¸­çš„ View å¼•ç”¨

**æ”¹é€ æ¸…å•ï¼š**

| ViewModel æ–‡ä»¶ | å½“å‰ä»£ç  | æ”¹é€ å |
|----------------|----------|--------|
| `Core.cs` | `SetMainWindow(Window w)` | `SetDialogService(IDialogService ds)` |
| `TranslationAndUi.cs` | `_mediaStudioWindow = new MediaStudioWindow()` | `await _dialogService.ShowMediaStudioAsync()` |
| `ConfigAndSubscription.cs` | `new ConfigCenterView(_config).ShowDialog(...)` | `await _dialogService.ShowConfigCenterAsync(_config)` |
| `AudioDevices.cs` | `FindControl<ComboBox>(...)` | ä½¿ç”¨ Binding + Behavior æ›¿ä»£ |

**FindControl çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆä½¿ç”¨é™„åŠ è¡Œä¸ºï¼‰ï¼š**

```csharp
// æ”¹é€ å‰ï¼ˆViewModel ç›´æ¥è®¿é—® View æ§ä»¶ï¼‰
var comboBox = _mainWindow.FindControl<ComboBox>("SubscriptionComboBox");
comboBox.SelectedIndex = 0;

// æ”¹é€ åï¼ˆé€šè¿‡ç»‘å®šå®ç°ï¼‰
// ViewModel:
private int _selectedSubscriptionIndex;
public int SelectedSubscriptionIndex
{
    get => _selectedSubscriptionIndex;
    set => SetProperty(ref _selectedSubscriptionIndex, value);
}

// AXAML:
<ComboBox x:Name="SubscriptionComboBox"
          SelectedIndex="{Binding SelectedSubscriptionIndex}" />
```

---

## 4. æœåŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 4.1 ç”Ÿå‘½å‘¨æœŸé€‰æ‹©æŒ‡å—

| ç”Ÿå‘½å‘¨æœŸ | é€‚ç”¨æ¡ä»¶ | ç¤ºä¾‹ |
|----------|----------|------|
| **Singleton** | æœ‰çŠ¶æ€ã€å…¨å±€å…±äº«ã€æ˜‚è´µåˆ›å»º | ConfigurationService, AzureTokenProvider, SpeechTranslationService |
| **Scoped** | æ¯æ¬¡æ“ä½œ/ä¼šè¯ç‹¬ç«‹ | ï¼ˆAvalonia æ¡Œé¢åº”ç”¨é€šå¸¸ä¸ç”¨ Scopedï¼‰ |
| **Transient** | æ— çŠ¶æ€ã€è½»é‡ã€æŒ‰éœ€åˆ›å»º | AudioFormatConverter, ImageCropService, ViewModel |

### 4.2 æœåŠ¡åˆ†ç±»æ€»è¡¨

```
Singletonï¼ˆå…± 12 ä¸ªï¼‰:
â”œâ”€â”€ PathManager               - è·¯å¾„å›ºå®šï¼Œå…¨å±€å…±äº«
â”œâ”€â”€ AppLogService              - æ—¥å¿—ç³»ç»Ÿï¼Œå…¨å±€å”¯ä¸€
â”œâ”€â”€ CrashLogger                - å´©æºƒæ—¥å¿—ï¼Œå…¨å±€å”¯ä¸€
â”œâ”€â”€ ConfigurationService       - é…ç½®åŠ è½½/ä¿å­˜ï¼Œéœ€è¦ä¸€è‡´çš„æ–‡ä»¶è®¿é—®
â”œâ”€â”€ AzureTokenProvider         - Token ç¼“å­˜ï¼Œè®¤è¯çŠ¶æ€
â”œâ”€â”€ AzureSubscriptionValidator - éªŒè¯ç»“æœç¼“å­˜
â”œâ”€â”€ SpeechTranslationService   - æŒæœ‰ SDK è¿æ¥ã€éŸ³é¢‘è®¾å¤‡
â”œâ”€â”€ AiInsightService           - æŒæœ‰ HTTP å®¢æˆ·ç«¯
â”œâ”€â”€ SpeechBatchApiClient       - æŒæœ‰ HTTP å®¢æˆ·ç«¯
â”œâ”€â”€ SubtitleSyncService        - æ— çŠ¶æ€ä½†åˆ›å»ºå¼€é”€ä½
â”œâ”€â”€ AudioDeviceEnumerator      - è®¾å¤‡åˆ—è¡¨ç¼“å­˜
â””â”€â”€ FloatingSubtitleManager    - ç®¡ç†æµ®åŠ¨çª—å£ç”Ÿå‘½å‘¨æœŸ

Transientï¼ˆå…± 8 ä¸ªï¼‰:
â”œâ”€â”€ AudioFormatConverter       - æŒ‰éœ€è½¬æ¢ï¼Œæ— çŠ¶æ€
â”œâ”€â”€ ImageCropService           - æŒ‰éœ€è£å‰ªï¼Œæ— çŠ¶æ€
â”œâ”€â”€ VideoFrameExtractorService - æŒ‰éœ€æå–ï¼Œæ— çŠ¶æ€
â”œâ”€â”€ BlobStorageService         - æ¯æ¬¡æ“ä½œç‹¬ç«‹è¿æ¥
â”œâ”€â”€ MarkdownContentLoader      - æŒ‰éœ€åŠ è½½ï¼Œæ— çŠ¶æ€
â”œâ”€â”€ AiImageGenService          - æ¯æ¬¡ç”Ÿæˆç‹¬ç«‹
â”œâ”€â”€ AiVideoGenService          - æ¯æ¬¡ç”Ÿæˆç‹¬ç«‹
â””â”€â”€ VideoCapabilityResolver    - æŒ‰éœ€æŸ¥è¯¢ï¼Œæ— çŠ¶æ€
```

### 4.3 IDisposable æœåŠ¡çš„é‡Šæ”¾

```csharp
// åœ¨ App.axaml.cs ä¸­å¤„ç†åº”ç”¨å…³é—­
public override void OnFrameworkInitializationCompleted()
{
    // ... åˆå§‹åŒ–

    if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
    {
        desktop.ShutdownRequested += (_, _) =>
        {
            // é‡Šæ”¾ DI å®¹å™¨ä¸­æ‰€æœ‰ IDisposable æœåŠ¡
            if (Services is IDisposable disposable)
            {
                disposable.Dispose();
            }
        };
    }
}
```

---

## 5. ç›®å½•ç»“æ„é‡ç»„å»ºè®®

### 5.1 å½“å‰ç»“æ„

```
TrueFluentPro/
â”œâ”€â”€ Controls/          # è‡ªå®šä¹‰æ§ä»¶ + è½¬æ¢å™¨ï¼ˆæ··åœ¨ä¸€èµ·ï¼‰
â”œâ”€â”€ Helpers/           # 2 ä¸ªè¾…åŠ©ç±»
â”œâ”€â”€ Models/            # 21 ä¸ªæ¨¡å‹ï¼ˆé…ç½®ã€æ•°æ®ã€æšä¸¾æ··åœ¨ä¸€èµ·ï¼‰
â”œâ”€â”€ Services/          # 24 ä¸ªæœåŠ¡ï¼ˆå±‚çº§ç»“æ„ä¸æ¸…æ™°ï¼‰
â”‚   â””â”€â”€ Audio/         # éŸ³é¢‘ä¸“ç”¨æœåŠ¡
â”œâ”€â”€ ViewModels/        # 9+ ViewModel æ–‡ä»¶
â””â”€â”€ Views/             # 10 ä¸ªè§†å›¾
```

### 5.2 å»ºè®®ç»“æ„

```
TrueFluentPro/
â”œâ”€â”€ Interfaces/                    # ğŸ†• æœåŠ¡æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ IConfigurationService.cs
â”‚   â”œâ”€â”€ IAzureTokenProvider.cs
â”‚   â”œâ”€â”€ ISpeechTranslationService.cs
â”‚   â”œâ”€â”€ IAiInsightService.cs
â”‚   â”œâ”€â”€ IDialogService.cs
â”‚   â””â”€â”€ ISpeechBatchApiClient.cs
â”‚
â”œâ”€â”€ Models/                        # ğŸ“¦ æ•°æ®æ¨¡å‹ï¼ˆä¿æŒç°æœ‰ + åˆ†å­ç›®å½•ï¼‰
â”‚   â”œâ”€â”€ Config/                    # é…ç½®ç±»
â”‚   â”‚   â”œâ”€â”€ AzureSpeechConfig.cs
â”‚   â”‚   â”œâ”€â”€ AzureSubscription.cs
â”‚   â”‚   â”œâ”€â”€ AiConfig.cs
â”‚   â”‚   â””â”€â”€ MediaGenConfig.cs
â”‚   â”œâ”€â”€ Speech/                    # è¯­éŸ³/ç¿»è¯‘
â”‚   â”‚   â”œâ”€â”€ TranslationItem.cs
â”‚   â”‚   â”œâ”€â”€ SubtitleCue.cs
â”‚   â”‚   â””â”€â”€ BatchTaskItem.cs
â”‚   â”œâ”€â”€ Media/                     # åª’ä½“ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ MediaGenSession.cs
â”‚   â”‚   â”œâ”€â”€ MediaGenTask.cs
â”‚   â”‚   â””â”€â”€ MediaFileItem.cs
â”‚   â””â”€â”€ Enums/                     # æšä¸¾
â”‚       â”œâ”€â”€ AudioSourceMode.cs
â”‚       â”œâ”€â”€ RecordingMode.cs
â”‚       â”œâ”€â”€ TextEditorType.cs
â”‚       â””â”€â”€ VideoApiMode.cs
â”‚
â”œâ”€â”€ Services/                      # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ Config/                    # é…ç½®ä¸å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ ConfigurationService.cs
â”‚   â”‚   â””â”€â”€ PathManager.cs
â”‚   â”œâ”€â”€ Speech/                    # è¯­éŸ³æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ SpeechTranslationService.cs
â”‚   â”‚   â”œâ”€â”€ SpeechBatchApiClient.cs
â”‚   â”‚   â”œâ”€â”€ BatchTranscriptionParser.cs
â”‚   â”‚   â””â”€â”€ SubtitleFileParser.cs
â”‚   â”œâ”€â”€ AI/                        # AI æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ AiInsightService.cs
â”‚   â”‚   â”œâ”€â”€ AiImageGenService.cs
â”‚   â”‚   â”œâ”€â”€ AiVideoGenService.cs
â”‚   â”‚   â””â”€â”€ AiMediaServiceBase.cs
â”‚   â”œâ”€â”€ Audio/                     # éŸ³é¢‘ï¼ˆå·²æœ‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ WasapiPcm16AudioSource.cs
â”‚   â”‚   â”œâ”€â”€ HighQualityRecorder.cs
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ Auth/                      # ğŸ†• è®¤è¯
â”‚   â”‚   â”œâ”€â”€ AzureTokenProvider.cs
â”‚   â”‚   â””â”€â”€ AzureSubscriptionValidator.cs
â”‚   â”œâ”€â”€ Cloud/                     # ğŸ†• äº‘æœåŠ¡
â”‚   â”‚   â””â”€â”€ BlobStorageService.cs
â”‚   â”œâ”€â”€ UI/                        # ğŸ†• UI æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ DialogService.cs
â”‚   â”‚   â”œâ”€â”€ FloatingSubtitleManager.cs
â”‚   â”‚   â””â”€â”€ AppIconProvider.cs
â”‚   â””â”€â”€ Logging/                   # ğŸ†• æ—¥å¿—
â”‚       â”œâ”€â”€ AppLogService.cs
â”‚       â”œâ”€â”€ CrashLogger.cs
â”‚       â””â”€â”€ BatchLogService.cs
â”‚
â”œâ”€â”€ ViewModels/                    # ViewModel å±‚
â”‚   â”œâ”€â”€ Base/                      # ğŸ†• åŸºç¡€ç±»
â”‚   â”‚   â”œâ”€â”€ ViewModelBase.cs
â”‚   â”‚   â””â”€â”€ RelayCommand.cs        # è¿ç§»åˆ° CommunityToolkit åå¯åˆ é™¤
â”‚   â”œâ”€â”€ MainWindowViewModel.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.Core.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.Commands.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.ConfigAndSubscription.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.TranslationAndUi.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.AudioDevices.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.Playback.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.Insight.cs
â”‚   â”œâ”€â”€ MainWindowViewModel.ReviewBatch.cs   # å¾…æ‹†åˆ†
â”‚   â”œâ”€â”€ MediaStudioViewModel.cs
â”‚   â”œâ”€â”€ FloatingSubtitleViewModel.cs
â”‚   â””â”€â”€ ReferenceImageCropViewModel.cs
â”‚
â”œâ”€â”€ Views/                         # View å±‚ï¼ˆä¿æŒç°æœ‰ï¼‰
â”‚   â”œâ”€â”€ ...
â”‚
â”œâ”€â”€ Controls/                      # è‡ªå®šä¹‰æ§ä»¶
â”‚   â”œâ”€â”€ Editors/                   # ğŸ†• æ–‡æœ¬ç¼–è¾‘å™¨
â”‚   â”‚   â”œâ”€â”€ AdvancedRichTextBox.cs
â”‚   â”‚   â”œâ”€â”€ SimpleRichTextBox.cs
â”‚   â”‚   â””â”€â”€ ConfigurableTextEditor.cs
â”‚   â”œâ”€â”€ Panels/                    # ğŸ†• åŠŸèƒ½é¢æ¿
â”‚   â”‚   â”œâ”€â”€ AadLoginPanel.axaml / .cs
â”‚   â”‚   â”œâ”€â”€ PresetButtonsEditor.axaml / .cs
â”‚   â”‚   â””â”€â”€ ReviewSheetsEditor.axaml / .cs
â”‚   â””â”€â”€ Converters/                # ğŸ†• å€¼è½¬æ¢å™¨
â”‚       â”œâ”€â”€ LevelToHeightConverter.cs
â”‚       â”œâ”€â”€ ProgressToOffsetConverter.cs
â”‚       â”œâ”€â”€ FilePathToBitmapConverter.cs
â”‚       â””â”€â”€ FirstFrameBadgeVisibilityConverter.cs
â”‚
â”œâ”€â”€ Constants/                     # ğŸ†• å¸¸é‡
â”‚   â”œâ”€â”€ AppDefaults.cs
â”‚   â””â”€â”€ Strings.cs
â”‚
â”œâ”€â”€ Helpers/                       # è¾…åŠ©ç±»ï¼ˆä¿æŒç°æœ‰ï¼‰
â”‚   â”œâ”€â”€ ConfigViewHelper.cs
â”‚   â””â”€â”€ TimeLinkHelper.cs
â”‚
â””â”€â”€ Assets/                        # èµ„æºï¼ˆä¿æŒç°æœ‰ï¼‰
    â””â”€â”€ ...
```

### 5.3 ç›®å½•é‡ç»„å®æ–½è¦ç‚¹

> âš ï¸ **é‡è¦æç¤º**ï¼šç›®å½•é‡ç»„æ˜¯é«˜é£é™©æ“ä½œï¼Œå»ºè®®åœ¨ DI å’Œæ¥å£ç¨³å®šä¹‹åå†è¿›è¡Œã€‚

1. **å‘½åç©ºé—´ç­–ç•¥**ï¼šé‡ç»„åéœ€æ›´æ–°æ‰€æœ‰æ–‡ä»¶çš„ `namespace` å£°æ˜
2. **AXAML å¼•ç”¨**ï¼š`xmlns:controls="..."` ç­‰å‘½åç©ºé—´å¼•ç”¨éœ€åŒæ­¥æ›´æ–°
3. **æ¸è¿›å¼è¿ç§»**ï¼šä¸€æ¬¡åªç§»åŠ¨ä¸€ä¸ªå­ç›®å½•ï¼Œç¡®ä¿ç¼–è¯‘é€šè¿‡
4. **IDE æ”¯æŒ**ï¼šä½¿ç”¨ IDE çš„ã€ŒMove Typeã€é‡æ„åŠŸèƒ½ï¼ˆVS / Riderï¼‰ï¼Œè‡ªåŠ¨æ›´æ–°å¼•ç”¨
5. **CSPROJ**ï¼šä¸éœ€è¦æ‰‹åŠ¨ç»´æŠ¤æ–‡ä»¶åˆ—è¡¨ï¼ˆSDK-style é¡¹ç›®è‡ªåŠ¨åŒ…å«ï¼‰

---

## å®æ–½æ£€æŸ¥æ¸…å•

### Phase 1ï¼šDI å®¹å™¨åŸºç¡€ï¼ˆç¬¬ 1 å‘¨ï¼‰

- [ ] å®‰è£… `Microsoft.Extensions.DependencyInjection`
- [ ] å®‰è£… `Microsoft.Extensions.Logging`
- [ ] åœ¨ `App.axaml.cs` ä¸­åˆ›å»º `ServiceCollection`
- [ ] æ³¨å†Œ `MainWindowViewModel`ï¼ˆä¿æŒå†…éƒ¨ `new()`ï¼‰
- [ ] éªŒè¯åº”ç”¨æ­£å¸¸å¯åŠ¨

### Phase 2ï¼šæ¥å£æå–ï¼ˆç¬¬ 2-3 å‘¨ï¼‰

- [ ] åˆ›å»º `Interfaces/` ç›®å½•
- [ ] æå– `IConfigurationService` + æ›´æ–°æ³¨å†Œ
- [ ] æå– `IAzureTokenProvider` + æ›´æ–°æ³¨å†Œ
- [ ] æå– `ISpeechTranslationService` + æ›´æ–°æ³¨å†Œ
- [ ] æå– `IAiInsightService` + æ›´æ–°æ³¨å†Œ
- [ ] æå– `ISpeechBatchApiClient` + æ›´æ–°æ³¨å†Œ
- [ ] æ¯ä¸ªæ¥å£æå–åç¼–è¯‘éªŒè¯

### Phase 3ï¼šViewModel è§£è€¦ï¼ˆç¬¬ 3-4 å‘¨ï¼‰

- [ ] å®ç° `IDialogService` + `DialogService`
- [ ] æ”¹é€  `MainWindowViewModel` æ„é€ å‡½æ•°ï¼ˆå‚æ•°æ³¨å…¥ï¼‰
- [ ] æ¶ˆé™¤ `SetMainWindow()` â†’ æ”¹ä¸º `SetDialogService()`
- [ ] æ¶ˆé™¤ `_mediaStudioWindow` ç›´æ¥å¼•ç”¨
- [ ] æ¶ˆé™¤ `FindControl<>()` è°ƒç”¨ï¼ˆæ”¹ç”¨ Bindingï¼‰
- [ ] æ”¹é€  `MediaStudioViewModel` æ„é€ å‡½æ•°

### Phase 4ï¼šç›®å½•é‡ç»„ï¼ˆç¬¬ 5-6 å‘¨ï¼Œå¯é€‰ï¼‰

- [ ] åˆ†æ‰¹ç§»åŠ¨ Models åˆ°å­ç›®å½•
- [ ] åˆ†æ‰¹ç§»åŠ¨ Services åˆ°å­ç›®å½•
- [ ] åˆ†æ‰¹ç§»åŠ¨ Controls åˆ°å­ç›®å½•
- [ ] æ›´æ–°æ‰€æœ‰å‘½åç©ºé—´å¼•ç”¨
- [ ] å…¨é‡ç¼–è¯‘éªŒè¯
