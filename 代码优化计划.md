# ä»£ç ä¼˜åŒ–è®¡åˆ’

> åŸºäº TrueFluentPro å½“å‰ä»£ç åº“çš„å…¨é¢å®¡æŸ¥ï¼Œæå‡ºä»¥ä¸‹ä¼˜åŒ–å»ºè®®ã€‚æ‰€æœ‰å»ºè®®å‡åŸºäº .NET / Avalonia UI æœ€ä½³å®è·µï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åˆ—ï¼Œé™„å¸¦å…·ä½“çš„å®æ–½è·¯å¾„å’Œä»£ç ç¤ºä¾‹ã€‚

---

## ç›®å½•

1. [å¼•å…¥ CommunityToolkit.Mvvm æ›¿ä»£æ‰‹å†™ MVVM åŸºç¡€è®¾æ–½](#1-å¼•å…¥-communitytoolkitmvvm-æ›¿ä»£æ‰‹å†™-mvvm-åŸºç¡€è®¾æ–½)
2. [ä¿®å¤ async void é—®é¢˜](#2-ä¿®å¤-async-void-é—®é¢˜)
3. [å¼•å…¥ä¾èµ–æ³¨å…¥å®¹å™¨](#3-å¼•å…¥ä¾èµ–æ³¨å…¥å®¹å™¨)
4. [æ¶ˆé™¤ ViewModel å¯¹ View çš„ç›´æ¥å¼•ç”¨](#4-æ¶ˆé™¤-viewmodel-å¯¹-view-çš„ç›´æ¥å¼•ç”¨)
5. [ä¸ºæ ¸å¿ƒæœåŠ¡æå–æ¥å£](#5-ä¸ºæ ¸å¿ƒæœåŠ¡æå–æ¥å£)
6. [ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥](#6-ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥)
7. [æ¶ˆé™¤ç¡¬ç¼–ç å­—ç¬¦ä¸²ä¸é­”æ³•æ•°å­—](#7-æ¶ˆé™¤ç¡¬ç¼–ç å­—ç¬¦ä¸²ä¸é­”æ³•æ•°å­—)
8. [æ‹†åˆ†è¶…å¤§æ–‡ä»¶ ReviewBatch](#8-æ‹†åˆ†è¶…å¤§æ–‡ä»¶-reviewbatch)
9. [æ”¹è¿›èµ„æºé‡Šæ”¾ä¸å†…å­˜ç®¡ç†](#9-æ”¹è¿›èµ„æºé‡Šæ”¾ä¸å†…å­˜ç®¡ç†)
10. [JSON åºåˆ—åŒ–ç»Ÿä¸€](#10-json-åºåˆ—åŒ–ç»Ÿä¸€)
11. [æ—¥å¿—ä¸è¯Šæ–­å¢å¼º](#11-æ—¥å¿—ä¸è¯Šæ–­å¢å¼º)
12. [å¼•å…¥å•å…ƒæµ‹è¯•åŸºç¡€è®¾æ–½](#12-å¼•å…¥å•å…ƒæµ‹è¯•åŸºç¡€è®¾æ–½)

> ğŸ“ è¯¦ç»†çš„å¼‚æ­¥/é”™è¯¯å¤„ç†ä¸“é¡¹æ–¹æ¡ˆè§ [ä»£ç ä¼˜åŒ–è®¡åˆ’-å¼‚æ­¥ä¸é”™è¯¯å¤„ç†ä¸“é¡¹.md](ä»£ç ä¼˜åŒ–è®¡åˆ’-å¼‚æ­¥ä¸é”™è¯¯å¤„ç†ä¸“é¡¹.md)  
> ğŸ“ è¯¦ç»†çš„æ¶æ„ä¸ä¾èµ–æ³¨å…¥ä¸“é¡¹æ–¹æ¡ˆè§ [ä»£ç ä¼˜åŒ–è®¡åˆ’-æ¶æ„ä¸ä¾èµ–æ³¨å…¥ä¸“é¡¹.md](ä»£ç ä¼˜åŒ–è®¡åˆ’-æ¶æ„ä¸ä¾èµ–æ³¨å…¥ä¸“é¡¹.md)

---

## 1. å¼•å…¥ CommunityToolkit.Mvvm æ›¿ä»£æ‰‹å†™ MVVM åŸºç¡€è®¾æ–½

### å½“å‰é—®é¢˜

- `ViewModelBase.cs`ï¼ˆ29 è¡Œï¼‰å’Œ `RelayCommand.cs`ï¼ˆ36 è¡Œï¼‰æ˜¯æ‰‹å†™å®ç°
- ç¼ºå°‘ `[ObservableProperty]`ã€`[RelayCommand]` ç­‰æºç”Ÿæˆå™¨æ”¯æŒ
- MainWindowViewModel ä¸­æœ‰å¤§é‡é‡å¤çš„å±æ€§é€šçŸ¥æ ·æ¿ä»£ç 

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šå®‰è£… NuGet åŒ…**

```bash
dotnet add package CommunityToolkit.Mvvm --version 8.4.0
```

**æ­¥éª¤ 2ï¼šæ”¹é€  ViewModelBase**

```csharp
// æ”¹é€ å‰
public class ViewModelBase : INotifyPropertyChanged
{
    public event PropertyChangedEventHandler? PropertyChanged;
    protected void OnPropertyChanged([CallerMemberName] string? name = null)
        => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
    protected bool SetProperty<T>(ref T field, T value, [CallerMemberName] string? name = null)
    {
        if (EqualityComparer<T>.Default.Equals(field, value)) return false;
        field = value;
        OnPropertyChanged(name);
        return true;
    }
}

// æ”¹é€ å
using CommunityToolkit.Mvvm.ComponentModel;

public partial class ViewModelBase : ObservableObject { }
```

**æ­¥éª¤ 3ï¼šé€æ­¥è¿ç§»å±æ€§ï¼ˆç¤ºä¾‹ï¼šMainWindowViewModel.csï¼‰**

```csharp
// æ”¹é€ å‰ - æ‰‹å†™å±æ€§ï¼ˆ~10è¡Œ/å±æ€§ï¼‰
private string _statusMessage = "å°±ç»ª";
public string StatusMessage
{
    get => _statusMessage;
    set => SetProperty(ref _statusMessage, value);
}

// æ”¹é€ å - æºç”Ÿæˆå™¨ï¼ˆ2è¡Œ/å±æ€§ï¼‰
[ObservableProperty]
private string _statusMessage = "å°±ç»ª";
```

**æ­¥éª¤ 4ï¼šè¿ç§» RelayCommand**

```csharp
// æ”¹é€ å‰
public ICommand StartCommand { get; }
// åœ¨æ„é€ å‡½æ•°ä¸­: StartCommand = new RelayCommand(Start);

// æ”¹é€ å
[RelayCommand]
private void Start() { ... }
// è‡ªåŠ¨ç”Ÿæˆ StartCommand å±æ€§
```

### é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | æ”¹é€ å‰ | æ”¹é€ å |
|------|--------|--------|
| æ¯ä¸ªå±æ€§ä»£ç è¡Œæ•° | 7-10 è¡Œ | 2 è¡Œ |
| MainWindowViewModel æ€»è¡Œæ•° | ~400 è¡Œ | ~200 è¡Œï¼ˆå‡å°‘ 50%ï¼‰|
| å‘½ä»¤å£°æ˜ä»£ç  | æ‰‹å†™ + æ„é€ å‡½æ•°ç»‘å®š | è‡ªåŠ¨ç”Ÿæˆ |
| ç±»å‹å®‰å…¨ | è¿è¡Œæ—¶æ£€æŸ¥ | ç¼–è¯‘æ—¶æ£€æŸ¥ |

### é£é™©æ§åˆ¶

- **å…¼å®¹æ€§**ï¼šCommunityToolkit.Mvvm æ”¯æŒ .NET 6+ï¼Œä¸ .NET 10 å®Œå…¨å…¼å®¹
- **æ¸è¿›å¼è¿ç§»**ï¼šå¯ä»¥æ–‡ä»¶çº§åˆ«é€æ­¥è¿ç§»ï¼Œæ–°æ—§ä»£ç å…±å­˜
- **å›é€€ç­–ç•¥**ï¼šåŸæœ‰ `SetProperty` å’Œ `RelayCommand` å¯ä¿ç•™ï¼Œæ–°å¢å±æ€§ä½¿ç”¨æºç”Ÿæˆå™¨

---

## 2. ä¿®å¤ async void é—®é¢˜

### å½“å‰é—®é¢˜

ä»¥ä¸‹æ–¹æ³•ä½¿ç”¨äº† `async void`ï¼ˆéäº‹ä»¶å¤„ç†å™¨ï¼‰ï¼Œå¯èƒ½å¯¼è‡´æœªæ•è·çš„å¼‚å¸¸å¯¼è‡´åº”ç”¨å´©æºƒï¼š

| æ–‡ä»¶ | æ–¹æ³• | è¡Œå·ï¼ˆçº¦ï¼‰ |
|------|------|------------|
| `MainWindowViewModel.Insight.cs` | `SendInsight()` | 129 |
| `MainWindowViewModel.TranslationAndUi.cs` | `StartTranslation()` | 250 |
| `MainWindowViewModel.TranslationAndUi.cs` | `StopTranslation()` | 270 |
| `MainWindowViewModel.ReviewBatch.cs` | `GenerateReviewSummary()` | 175 |
| `MainWindowViewModel.ReviewBatch.cs` | `GenerateAllReviewSheets()` | 220 |
| `MainWindowViewModel.ReviewBatch.cs` | `GenerateSpeechSubtitle()` | 285 |
| `MainWindowViewModel.ReviewBatch.cs` | `GenerateBatchSpeechSubtitle()` | 330 |

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šä½¿ç”¨ AsyncRelayCommand**

```csharp
// æ”¹é€ å‰
public ICommand StartTranslationCommand { get; }
// æ„é€ å‡½æ•°: StartTranslationCommand = new RelayCommand(StartTranslation);
private async void StartTranslation()
{
    try { await DoWorkAsync(); }
    catch (Exception ex) { StatusMessage = ex.Message; }
}

// æ”¹é€ å - CommunityToolkit.Mvvm
[RelayCommand]
private async Task StartTranslationAsync()
{
    await DoWorkAsync();  // å¼‚å¸¸è‡ªåŠ¨ä¼ æ’­åˆ°å‘½ä»¤å±‚
}
```

**æ–¹æ¡ˆ Bï¼ˆæœ€å°æ”¹åŠ¨ï¼‰ï¼šåŒ…è£…ä¸º async Task + å…¨å±€å¼‚å¸¸å¤„ç†**

```csharp
// åœ¨ RelayCommand ä¸­æ”¯æŒå¼‚æ­¥
private async void StartTranslation()
{
    await StartTranslationAsync();  // å§”æ‰˜ç»™ async Task æ–¹æ³•
}

private async Task StartTranslationAsync()
{
    try
    {
        await DoWorkAsync();
    }
    catch (OperationCanceledException) { /* å¿½ç•¥å–æ¶ˆ */ }
    catch (Exception ex)
    {
        await HandleErrorAsync(ex);
    }
}
```

### è¯¦ç»†ä¿®æ”¹æ¸…å•

> ğŸ“ å®Œæ•´çš„é€æ–‡ä»¶ä¿®æ”¹æ–¹æ¡ˆè§ [ä»£ç ä¼˜åŒ–è®¡åˆ’-å¼‚æ­¥ä¸é”™è¯¯å¤„ç†ä¸“é¡¹.md](ä»£ç ä¼˜åŒ–è®¡åˆ’-å¼‚æ­¥ä¸é”™è¯¯å¤„ç†ä¸“é¡¹.md)

---

## 3. å¼•å…¥ä¾èµ–æ³¨å…¥å®¹å™¨

### å½“å‰é—®é¢˜

- æ‰€æœ‰æœåŠ¡é€šè¿‡ `new()` ç›´æ¥å®ä¾‹åŒ–
- `MainWindowViewModel` æ„é€ å‡½æ•°ä¸­æ‰‹åŠ¨åˆ›å»º ~8 ä¸ªæœåŠ¡å®ä¾‹
- æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¸é€æ˜
- æ— æ³•è¿›è¡Œå•å…ƒæµ‹è¯•ï¼ˆæ— æ³• mock æœåŠ¡ï¼‰

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ¨èä½¿ç”¨ `Microsoft.Extensions.DependencyInjection`**ï¼ˆ.NET å†…å»ºï¼Œæ— éœ€é¢å¤–ä¾èµ–ï¼‰

**æ­¥éª¤ 1ï¼šå®‰è£… NuGet åŒ…**

```bash
dotnet add package Microsoft.Extensions.DependencyInjection
```

**æ­¥éª¤ 2ï¼šåœ¨ App.axaml.cs ä¸­é…ç½®æœåŠ¡å®¹å™¨**

```csharp
public partial class App : Application
{
    public static IServiceProvider Services { get; private set; } = null!;

    public override void OnFrameworkInitializationCompleted()
    {
        var services = new ServiceCollection();

        // æ³¨å†ŒæœåŠ¡ï¼ˆå•ä¾‹/ç¬æ€ï¼‰
        services.AddSingleton<ConfigurationService>();
        services.AddSingleton<PathManager>();
        services.AddSingleton<AppLogService>();
        services.AddSingleton<AzureTokenProvider>();
        services.AddSingleton<SpeechTranslationService>();
        services.AddSingleton<AiInsightService>();
        services.AddTransient<AiImageGenService>();
        services.AddTransient<AiVideoGenService>();

        // æ³¨å†Œ ViewModel
        services.AddTransient<MainWindowViewModel>();
        services.AddTransient<MediaStudioViewModel>();

        Services = services.BuildServiceProvider();

        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow
            {
                DataContext = Services.GetRequiredService<MainWindowViewModel>()
            };
        }

        base.OnFrameworkInitializationCompleted();
    }
}
```

**æ­¥éª¤ 3ï¼šæ”¹é€  ViewModel æ„é€ å‡½æ•°**

```csharp
// æ”¹é€ å‰
public MainWindowViewModel()
{
    _configService = new ConfigurationService();
    _aiInsightService = new AiInsightService(new AzureTokenProvider());
    _config = new AzureSpeechConfig();
    // ...
}

// æ”¹é€ å
public MainWindowViewModel(
    ConfigurationService configService,
    AiInsightService aiInsightService,
    AzureSpeechConfig config)
{
    _configService = configService;
    _aiInsightService = aiInsightService;
    _config = config;
}
```

> ğŸ“ å®Œæ•´çš„ DI è¿ç§»æ–¹æ¡ˆè§ [ä»£ç ä¼˜åŒ–è®¡åˆ’-æ¶æ„ä¸ä¾èµ–æ³¨å…¥ä¸“é¡¹.md](ä»£ç ä¼˜åŒ–è®¡åˆ’-æ¶æ„ä¸ä¾èµ–æ³¨å…¥ä¸“é¡¹.md)

---

## 4. æ¶ˆé™¤ ViewModel å¯¹ View çš„ç›´æ¥å¼•ç”¨

### å½“å‰é—®é¢˜

```csharp
// MainWindowViewModel.Core.cs - ç›´æ¥æŒæœ‰ Window å¼•ç”¨
public void SetMainWindow(Window mainWindow)

// MainWindowViewModel.TranslationAndUi.cs - ç›´æ¥åˆ›å»ºå’Œç®¡ç† View
private MediaStudioWindow? _mediaStudioWindow;

// MainWindowViewModel.ConfigAndSubscription.cs - ç›´æ¥æ˜¾ç¤ºå¯¹è¯æ¡†
var configView = new ConfigCenterView(_config);
var result = await configView.ShowDialog<bool>(_mainWindow);
```

### ä¼˜åŒ–æ–¹æ¡ˆ

**å¼•å…¥å¯¹è¯æ¡†æœåŠ¡ï¼ˆDialog Service Patternï¼‰**

```csharp
// æ­¥éª¤1ï¼šå®šä¹‰å¯¹è¯æ¡†æœåŠ¡æ¥å£
public interface IDialogService
{
    Task<bool> ShowConfigCenterAsync(AzureSpeechConfig config);
    Task ShowMediaStudioAsync(MediaStudioViewModel viewModel);
    Task<string?> ShowOpenFileDialogAsync(string title, string filter);
    Task ShowMessageAsync(string title, string message);
}

// æ­¥éª¤2ï¼šå®ç°å¯¹è¯æ¡†æœåŠ¡ï¼ˆæ”¾åœ¨ Services/ ä¸‹ï¼‰
public class DialogService : IDialogService
{
    private readonly Window _owner;

    public DialogService(Window owner) => _owner = owner;

    public async Task<bool> ShowConfigCenterAsync(AzureSpeechConfig config)
    {
        var view = new ConfigCenterView(config);
        return await view.ShowDialog<bool>(_owner);
    }

    public async Task ShowMediaStudioAsync(MediaStudioViewModel viewModel)
    {
        var window = new MediaStudioWindow { DataContext = viewModel };
        await window.ShowDialog(_owner);
    }
}

// æ­¥éª¤3ï¼šViewModel é€šè¿‡æ¥å£ä½¿ç”¨
public MainWindowViewModel(IDialogService dialogService, ...)
{
    _dialogService = dialogService;
}

private async Task OpenConfigCenter()
{
    var result = await _dialogService.ShowConfigCenterAsync(_config);
    if (result) { /* é‡æ–°åŠ è½½é…ç½® */ }
}
```

### éœ€è¦è¿ç§»çš„ç›´æ¥å¼•ç”¨æ¸…å•

| æ–‡ä»¶ | å¼•ç”¨ç±»å‹ | è¿ç§»ç›®æ ‡ |
|------|----------|----------|
| `Core.cs` â†’ `SetMainWindow()` | Window å¼•ç”¨ | é€šè¿‡ DI æ³¨å…¥ IDialogService |
| `TranslationAndUi.cs` â†’ `_mediaStudioWindow` | View å®ä¾‹ | é€šè¿‡ IDialogService ç®¡ç† |
| `ConfigAndSubscription.cs` â†’ `ConfigCenterView` | View åˆ›å»º | é€šè¿‡ IDialogService.ShowConfigCenterAsync |
| `AudioDevices.cs` â†’ `FindControl<ComboBox>` | UI æ§ä»¶æŸ¥æ‰¾ | é€šè¿‡è¡Œä¸ºï¼ˆBehaviorï¼‰æˆ–é™„åŠ å±æ€§ |

---

## 5. ä¸ºæ ¸å¿ƒæœåŠ¡æå–æ¥å£

### å½“å‰é—®é¢˜

- 24 ä¸ªæœåŠ¡ç±»å…¨éƒ¨ä½¿ç”¨å…·ä½“ç±»å‹ï¼Œæ— æ¥å£æŠ½è±¡
- æ— æ³•å¯¹ä¾èµ–æœåŠ¡çš„ä»£ç è¿›è¡Œå•å…ƒæµ‹è¯•
- æœåŠ¡æ›¿æ¢ï¼ˆå¦‚æ¢ç”¨ä¸åŒ TTS æä¾›å•†ï¼‰éœ€è¦ä¿®æ”¹è°ƒç”¨æ–¹ä»£ç 

### ä¼˜åŒ–æ–¹æ¡ˆ

**ä¼˜å…ˆä¸ºä»¥ä¸‹é«˜é¢‘æœåŠ¡æå–æ¥å£ï¼ˆç¬¬ä¸€æ‰¹ï¼‰ï¼š**

```csharp
// 1. é…ç½®æœåŠ¡
public interface IConfigurationService
{
    AzureSpeechConfig Load();
    void Save(AzureSpeechConfig config);
}

// 2. è¯­éŸ³ç¿»è¯‘æœåŠ¡
public interface ISpeechTranslationService
{
    Task StartTranslationAsync(AzureSubscription subscription, CancellationToken ct);
    Task StopTranslationAsync();
    event EventHandler<TranslationItem> TranslationReceived;
    bool IsTranslating { get; }
}

// 3. AI æ´å¯ŸæœåŠ¡
public interface IAiInsightService
{
    Task<string> AnalyzeAsync(string content, string prompt, CancellationToken ct);
    Task<string> StreamAnalyzeAsync(string content, string prompt,
        IProgress<string> progress, CancellationToken ct);
}

// 4. æ‰¹é‡è½¬å†™æœåŠ¡
public interface ISpeechBatchApiClient
{
    Task<string> CreateTranscriptionAsync(string audioUrl, string locale, CancellationToken ct);
    Task<BatchTaskStatus> GetTranscriptionStatusAsync(string transcriptionId, CancellationToken ct);
}

// 5. Azure Token æä¾›å™¨
public interface IAzureTokenProvider
{
    Task<string> GetTokenAsync(string resource, CancellationToken ct);
    Task<bool> TrySilentLoginAsync();
}
```

**ç¬¬äºŒæ‰¹ï¼ˆå¯é€‰ï¼Œä¼˜å…ˆçº§è¾ƒä½ï¼‰ï¼š**

```csharp
public interface IPathManager { ... }
public interface IAudioFormatConverter { ... }
public interface IBlobStorageService { ... }
public interface IFloatingSubtitleManager { ... }
```

### å®æ–½è¦ç‚¹

- æ¥å£æ–‡ä»¶æ”¾åœ¨æ–°å»ºçš„ `Interfaces/` ç›®å½•ä¸‹ï¼Œæˆ–æ”¾åœ¨ `Services/` ç›®å½•ä¸å®ç°ç±»åŒçº§
- æ¥å£å‘½åéµå¾ª `I` å‰ç¼€çº¦å®š
- å…ˆæå–æ¥å£ï¼Œå†åœ¨ DI å®¹å™¨ä¸­æ³¨å†Œæ¥å£â†’å®ç°æ˜ å°„
- ç°æœ‰ä»£ç å¯æ¸è¿›å¼è¿ç§»ï¼šå…ˆæ”¹ ViewModel æ„é€ å‡½æ•°å‚æ•°ç±»å‹

---

## 6. ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥

### å½“å‰é—®é¢˜

- é”™è¯¯å¤„ç†é£æ ¼ä¸ç»Ÿä¸€ï¼šæœ‰äº› `catch { }`ï¼ˆç©º catchï¼‰ï¼Œæœ‰äº›åªè®°æ—¥å¿—ï¼Œæœ‰äº›å¼¹çª—
- éƒ¨åˆ†å…³é”®æ“ä½œç¼ºå°‘ç”¨æˆ·åé¦ˆ
- æ²¡æœ‰ç»Ÿä¸€çš„é”™è¯¯æ—¥å¿—/è¿½è¸ªæœºåˆ¶

### ä¼˜åŒ–æ–¹æ¡ˆ

**å®šä¹‰ä¸‰çº§é”™è¯¯å¤„ç†ç­–ç•¥ï¼š**

```csharp
/// <summary>
/// å…¨å±€é”™è¯¯å¤„ç†æœåŠ¡
/// </summary>
public class ErrorHandlingService
{
    private readonly AppLogService _log;

    // çº§åˆ« 1ï¼šé™é»˜è®°å½•ï¼ˆåå°æ“ä½œï¼Œä¸å½±å“ç”¨æˆ·æµç¨‹ï¼‰
    public void LogSilent(Exception ex, string context)
    {
        _log.LogError($"[Silent] {context}: {ex.Message}");
    }

    // çº§åˆ« 2ï¼šçŠ¶æ€æ é€šçŸ¥ï¼ˆç”¨æˆ·å¯è§ä½†ä¸é˜»æ–­ï¼‰
    public void NotifyUser(Exception ex, string userMessage,
        Action<string> setStatus)
    {
        _log.LogError($"[Notify] {userMessage}: {ex.Message}");
        setStatus(userMessage);
    }

    // çº§åˆ« 3ï¼šå¼¹çª—è­¦å‘Šï¼ˆä¸¥é‡é”™è¯¯ï¼Œéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰
    public async Task AlertUserAsync(Exception ex, string title,
        IDialogService dialog)
    {
        _log.LogError($"[Alert] {title}: {ex}");
        await dialog.ShowMessageAsync(title, ex.Message);
    }
}
```

**éœ€è¦ä¿®æ­£çš„ç©º catch ä½ç½®ï¼š**

| æ–‡ä»¶ | ä½ç½® | å½“å‰ä»£ç  | å»ºè®® |
|------|------|----------|------|
| `MainWindow.axaml.cs` | 17-50 | `catch { }` | è‡³å°‘è®°å½•æ—¥å¿— |
| `ReferenceImageCropWindow.axaml.cs` | å¤šå¤„ | ç©º catch | è®°å½•æ—¥å¿— + çŠ¶æ€é€šçŸ¥ |
| `ConfigCenterView.axaml.cs` | æŒ‰é’®äº‹ä»¶ | ä¸ä¸€è‡´ | ç»Ÿä¸€ä½¿ç”¨ ErrorHandlingService |

> ğŸ“ å®Œæ•´çš„é”™è¯¯å¤„ç†æ”¹é€ æ¸…å•è§ [ä»£ç ä¼˜åŒ–è®¡åˆ’-å¼‚æ­¥ä¸é”™è¯¯å¤„ç†ä¸“é¡¹.md](ä»£ç ä¼˜åŒ–è®¡åˆ’-å¼‚æ­¥ä¸é”™è¯¯å¤„ç†ä¸“é¡¹.md)

---

## 7. æ¶ˆé™¤ç¡¬ç¼–ç å­—ç¬¦ä¸²ä¸é­”æ³•æ•°å­—

### å½“å‰é—®é¢˜

UI æ–‡æœ¬å’Œé…ç½®é»˜è®¤å€¼æ•£è½åœ¨ä»£ç ä¸­ï¼Œæ— æ³•æ”¯æŒå¤šè¯­è¨€ï¼Œä¹Ÿéš¾ä»¥ç»Ÿä¸€ä¿®æ”¹ï¼š

```csharp
// MainWindowViewModel.cs
private string _statusMessage = "å°±ç»ª";
_batchQueueStatusText = "é˜Ÿåˆ—ä¸ºç©º";

// MainWindowViewModel.TranslationAndUi.cs
"åŸæ–‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."
"è¯‘æ–‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º..."

// MainWindowViewModel.Insight.cs
int _autoInsightIntervalSeconds = 30;

// MainWindowViewModel.cs
private int _batchConcurrencyLimit = 10;
```

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šæå–å¸¸é‡ç±»**

```csharp
// Constants/AppDefaults.cs
public static class AppDefaults
{
    public const int AutoInsightIntervalSeconds = 30;
    public const int BatchConcurrencyLimit = 10;
    public const int DefaultHistoryLimit = 500;
    public const int DefaultSilenceTimeoutMs = 3000;
    public const int DefaultEndSilenceTimeoutMs = 1500;
    public const int DefaultMp3Bitrate = 128;
}
```

**æ­¥éª¤ 2ï¼šæå– UI æ–‡æœ¬èµ„æºï¼ˆä¸ºæœªæ¥å›½é™…åŒ–åšå‡†å¤‡ï¼‰**

```csharp
// Resources/Strings.cs
public static class Strings
{
    public const string StatusReady = "å°±ç»ª";
    public const string QueueEmpty = "é˜Ÿåˆ—ä¸ºç©º";
    public const string PlaceholderOriginal = "åŸæ–‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º...";
    public const string PlaceholderTranslated = "è¯‘æ–‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º...";
    public const string ErrorSubscriptionInvalid = "è®¢é˜…éªŒè¯å¤±è´¥";
    public const string ErrorNetworkTimeout = "ç½‘ç»œè¯·æ±‚è¶…æ—¶";
    // ... æ›´å¤šå­—ç¬¦ä¸²
}
```

**æ­¥éª¤ 3ï¼ˆå¯é€‰è¿›é˜¶ï¼‰ï¼šä½¿ç”¨ Avalonia èµ„æºå­—å…¸**

```xml
<!-- Resources/Strings.axaml -->
<ResourceDictionary xmlns="https://github.com/avaloniaui">
    <x:String x:Key="StatusReady">å°±ç»ª</x:String>
    <x:String x:Key="QueueEmpty">é˜Ÿåˆ—ä¸ºç©º</x:String>
</ResourceDictionary>
```

---

## 8. æ‹†åˆ†è¶…å¤§æ–‡ä»¶ ReviewBatch

### å½“å‰é—®é¢˜

- `MainWindowViewModel.ReviewBatch.cs` æœ‰ **2,375 è¡Œ**ï¼Œæ˜¯æœ€å¤§çš„å•æ–‡ä»¶
- åŒ…å«æ‰¹é‡è½¬å†™ã€å®¡æŸ¥è¡¨ç”Ÿæˆã€å­—å¹•å¤„ç†ç­‰å¤šä¸ªç‹¬ç«‹å…³æ³¨ç‚¹
- è¶…å¤§æ–‡ä»¶å½±å“å¯è¯»æ€§å’Œç»´æŠ¤æ€§

### ä¼˜åŒ–æ–¹æ¡ˆ

**å°† ReviewBatch æ‹†åˆ†ä¸º 4 ä¸ªæ–‡ä»¶ï¼š**

```
ViewModels/
â”œâ”€â”€ MainWindowViewModel.ReviewBatch.cs          # æ ¸å¿ƒæ‰¹é‡é˜Ÿåˆ—ç®¡ç†ï¼ˆ~500è¡Œï¼‰
â”œâ”€â”€ MainWindowViewModel.ReviewSheet.cs          # å®¡æŸ¥è¡¨ç”Ÿæˆé€»è¾‘ï¼ˆ~600è¡Œï¼‰
â”œâ”€â”€ MainWindowViewModel.SpeechSubtitle.cs       # å­—å¹•å¤„ç†é€»è¾‘ï¼ˆ~500è¡Œï¼‰
â””â”€â”€ MainWindowViewModel.BatchQueue.cs           # æ‰¹é‡é˜Ÿåˆ— UI çŠ¶æ€ç®¡ç†ï¼ˆ~400è¡Œï¼‰
```

**æ‹†åˆ†åŸåˆ™ï¼š**

1. **æŒ‰åŠŸèƒ½è¾¹ç•Œæ‹†åˆ†**ï¼šæ¯ä¸ª partial class æ–‡ä»¶åªå¤„ç†ä¸€ä¸ªç‹¬ç«‹çš„åŠŸèƒ½åŸŸ
2. **å­—æ®µå°±è¿‘åŸåˆ™**ï¼šç§æœ‰å­—æ®µå£°æ˜åœ¨ä½¿ç”¨å®ƒçš„æ–‡ä»¶ä¸­
3. **ç›®æ ‡è¡Œæ•°**ï¼šæ¯ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 600 è¡Œ
4. **æ–¹æ³•åˆ†ç»„**ï¼šç›¸å…³çš„ public/private æ–¹æ³•æ”¾åœ¨åŒä¸€æ–‡ä»¶

### å…·ä½“æ‹†åˆ†æ–¹æ¡ˆ

```
MainWindowViewModel.ReviewBatch.csï¼ˆä¿ç•™ï¼‰:
  - æ‰¹é‡é˜Ÿåˆ—å±æ€§å’Œå‘½ä»¤
  - EnqueueBatchTask()
  - ProcessBatchQueue()
  - BatchTaskCompleted()

MainWindowViewModel.ReviewSheet.csï¼ˆæ–°å»ºï¼‰:
  - å®¡æŸ¥è¡¨æ¨¡æ¿ç®¡ç†
  - GenerateReviewSummary()
  - GenerateAllReviewSheets()
  - å®¡æŸ¥è¡¨ AI è¯·æ±‚å’Œæ¸²æŸ“

MainWindowViewModel.SpeechSubtitle.csï¼ˆæ–°å»ºï¼‰:
  - GenerateSpeechSubtitle()
  - GenerateBatchSpeechSubtitle()
  - å­—å¹•è§£æå’Œå¯¼å‡º

MainWindowViewModel.BatchQueue.csï¼ˆæ–°å»ºï¼‰:
  - æ‰¹é‡ä»»åŠ¡ UI çŠ¶æ€
  - è¿›åº¦æŠ¥å‘Š
  - é˜Ÿåˆ—ç»Ÿè®¡
```

---

## 9. æ”¹è¿›èµ„æºé‡Šæ”¾ä¸å†…å­˜ç®¡ç†

### å½“å‰é—®é¢˜

- éƒ¨åˆ†äº‹ä»¶è®¢é˜…æœªå–æ¶ˆï¼ˆ`CollectionChanged` ç­‰ï¼‰
- `DispatcherTimer` çš„åœæ­¢æ—¶æœºä¸æ˜ç¡®
- å¹¶éæ‰€æœ‰æŒæœ‰éæ‰˜ç®¡èµ„æºçš„å¯¹è±¡éƒ½æ­£ç¡®é‡Šæ”¾

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šåœ¨ ViewModelBase ä¸­æ·»åŠ  Disposable æ”¯æŒ**

```csharp
public partial class ViewModelBase : ObservableObject, IDisposable
{
    private readonly CompositeDisposable _disposables = new();
    private bool _disposed;

    protected void AddDisposable(IDisposable disposable)
        => _disposables.Add(disposable);

    public void Dispose()
    {
        if (_disposed) return;
        _disposed = true;
        OnDispose();
        _disposables.Dispose();
        GC.SuppressFinalize(this);
    }

    protected virtual void OnDispose() { }
}
```

**æ­¥éª¤ 2ï¼šç»Ÿä¸€äº‹ä»¶è®¢é˜…æ¨¡å¼**

```csharp
// æ”¹é€ å‰ - è®¢é˜…åæ— æ³•å–æ¶ˆ
_translationHistory.CollectionChanged += OnHistoryChanged;

// æ”¹é€ å - ä½¿ç”¨ Rx æˆ–æ‰‹åŠ¨ç®¡ç†
private readonly List<(object source, Delegate handler)> _eventSubscriptions = new();

protected void Subscribe<THandler>(object source, string eventName, THandler handler)
    where THandler : Delegate
{
    var eventInfo = source.GetType().GetEvent(eventName);
    eventInfo?.AddEventHandler(source, handler);
    _eventSubscriptions.Add((source, handler));
}

protected override void OnDispose()
{
    foreach (var (source, handler) in _eventSubscriptions)
    {
        // å–æ¶ˆæ‰€æœ‰äº‹ä»¶è®¢é˜…
    }
}
```

**æ­¥éª¤ 3ï¼šDispatcherTimer ç”Ÿå‘½å‘¨æœŸç®¡ç†**

```csharp
// åœ¨ MainWindowViewModel.Core.cs çš„ Dispose ä¸­ç¡®ä¿åœæ­¢
protected override void OnDispose()
{
    _autoInsightTimer?.Stop();
    _autoInsightTimer = null;
    _playbackTimer?.Stop();
    _playbackTimer = null;
    _insightCts?.Cancel();
    _insightCts?.Dispose();
    _floatingSubtitleManager?.Dispose();
}
```

---

## 10. JSON åºåˆ—åŒ–ç»Ÿä¸€

### å½“å‰é—®é¢˜

- `ConfigurationService.cs` ä½¿ç”¨ `System.Text.Json`
- é¡¹ç›®ä¾èµ– `Newtonsoft.Json 13.0.3`
- ä¸¤å¥— JSON åº“å…±å­˜å¢åŠ äº†å¤æ‚æ€§

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šç»Ÿä¸€ä¸º System.Text.Json**

```csharp
// åˆ›å»ºå…¨å±€åºåˆ—åŒ–é…ç½®
public static class JsonConfig
{
    public static readonly JsonSerializerOptions Default = new()
    {
        WriteIndented = true,
        Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping,
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull,
        Converters = { new JsonStringEnumConverter() }
    };
}
```

- é€æ­¥æ›¿æ¢ `Newtonsoft.Json` å¼•ç”¨
- æ£€æŸ¥æ‰€æœ‰ `JsonConvert.SerializeObject` / `DeserializeObject` è°ƒç”¨
- éªŒè¯åºåˆ—åŒ–å…¼å®¹æ€§ï¼ˆå·²æœ‰é…ç½®æ–‡ä»¶çš„è¯»å–ä¸å—å½±å“ï¼‰
- æœ€ç»ˆç§»é™¤ `Newtonsoft.Json` NuGet ä¾èµ–

**æ–¹æ¡ˆ Bï¼ˆæ¸è¿›å¼ï¼‰ï¼šå¦‚æœ Newtonsoft æœ‰éš¾ä»¥æ›¿ä»£çš„åŠŸèƒ½**

- ä¿ç•™ Newtonsoft ä½†é™åˆ¶åœ¨ç‰¹å®šæœåŠ¡ä¸­ä½¿ç”¨
- æ–°ä»£ç ä¸€å¾‹ä½¿ç”¨ System.Text.Json
- åœ¨ä»£ç è§„èŒƒä¸­æ˜ç¡®æ ‡æ³¨

---

## 11. æ—¥å¿—ä¸è¯Šæ–­å¢å¼º

### å½“å‰é—®é¢˜

- `AppLogService` å’Œ `CrashLogger` åŠŸèƒ½æœ‰é™
- `BatchLogService` ç‹¬ç«‹äºä¸»æ—¥å¿—ä½“ç³»
- ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—ï¼ˆstructured loggingï¼‰
- è°ƒè¯•æ—¥å¿—ä¸ç”Ÿäº§æ—¥å¿—æ··åœ¨ä¸€èµ·

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šå¼•å…¥ Microsoft.Extensions.Logging**

```bash
dotnet add package Microsoft.Extensions.Logging
dotnet add package Microsoft.Extensions.Logging.Console
dotnet add package Microsoft.Extensions.Logging.Debug
```

```csharp
// åœ¨ DI å®¹å™¨ä¸­é…ç½®
services.AddLogging(builder =>
{
    builder.SetMinimumLevel(LogLevel.Information);
    builder.AddDebug();         // Debug è¾“å‡º
    builder.AddConsole();       // æ§åˆ¶å°è¾“å‡º
    // å¯é€‰: builder.AddFile("logs/app-{Date}.log");
});
```

**æ­¥éª¤ 2ï¼šåœ¨æœåŠ¡ä¸­ä½¿ç”¨ ILogger**

```csharp
public class SpeechTranslationService
{
    private readonly ILogger<SpeechTranslationService> _logger;

    public SpeechTranslationService(ILogger<SpeechTranslationService> logger)
    {
        _logger = logger;
    }

    public async Task StartTranslationAsync(...)
    {
        _logger.LogInformation("å¼€å§‹ç¿»è¯‘, è¯­è¨€å¯¹: {Source} â†’ {Target}", source, target);
        try
        {
            // ...
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ç¿»è¯‘å¤±è´¥");
            throw;
        }
    }
}
```

---

## 12. å¼•å…¥å•å…ƒæµ‹è¯•åŸºç¡€è®¾æ–½

### å½“å‰é—®é¢˜

- é¡¹ç›®æ²¡æœ‰ä»»ä½•æµ‹è¯•ä»£ç 
- æ²¡æœ‰æµ‹è¯•é¡¹ç›®æˆ–æµ‹è¯•æ¡†æ¶
- æ— æ³•éªŒè¯é‡æ„æ˜¯å¦å¼•å…¥å›å½’

### ä¼˜åŒ–æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šåˆ›å»ºæµ‹è¯•é¡¹ç›®**

```bash
dotnet new xunit -n TrueFluentPro.Tests
dotnet sln add TrueFluentPro.Tests/TrueFluentPro.Tests.csproj
dotnet add TrueFluentPro.Tests reference TrueFluentPro.csproj
```

**æ­¥éª¤ 2ï¼šå®‰è£… Mock æ¡†æ¶**

```bash
cd TrueFluentPro.Tests
dotnet add package Moq
dotnet add package FluentAssertions
```

**æ­¥éª¤ 3ï¼šç¼–å†™é¦–æ‰¹æµ‹è¯•ï¼ˆä¼˜å…ˆæµ‹è¯•çº¯é€»è¾‘ä»£ç ï¼‰**

```csharp
// é…ç½®æœåŠ¡æµ‹è¯•
public class ConfigurationServiceTests
{
    [Fact]
    public void Load_WhenFileExists_ReturnsConfig()
    {
        // Arrange
        var service = new ConfigurationService();
        // Act & Assert
        var config = service.Load();
        Assert.NotNull(config);
    }
}

// å­—å¹•è§£ææµ‹è¯•
public class BatchTranscriptionParserTests
{
    [Fact]
    public void ParseSrt_ValidInput_ReturnsCorrectCues()
    {
        var parser = new BatchTranscriptionParser();
        var srt = "1\n00:00:01,000 --> 00:00:02,000\nHello World\n";
        var cues = parser.Parse(srt);
        Assert.Single(cues);
        Assert.Equal("Hello World", cues[0].Text);
    }
}

// ViewModel æµ‹è¯•ï¼ˆéœ€è¦æ¥å£ + DI åï¼‰
public class MainWindowViewModelTests
{
    [Fact]
    public void StatusMessage_DefaultValue_IsReady()
    {
        var vm = CreateViewModel();
        Assert.Equal("å°±ç»ª", vm.StatusMessage);
    }
}
```

**æ¨èçš„åˆå§‹æµ‹è¯•è¦†ç›–ç›®æ ‡ï¼š**

| æ¨¡å— | æµ‹è¯•ç±»å‹ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| `ConfigurationService` | å•å…ƒæµ‹è¯• | P0 |
| `BatchTranscriptionParser` | å•å…ƒæµ‹è¯• | P0 |
| `SubtitleFileParser` | å•å…ƒæµ‹è¯• | P0 |
| `AzureSubscription` | å•å…ƒæµ‹è¯• | P1 |
| `AzureSpeechConfig` | åºåˆ—åŒ–æµ‹è¯• | P1 |
| `MainWindowViewModel` | ViewModel æµ‹è¯• | P2ï¼ˆéœ€ DI åï¼‰ |

---

## å®æ–½è·¯çº¿å›¾

### ç¬¬ä¸€é˜¶æ®µï¼šä½é£é™©é«˜æ”¶ç›Šï¼ˆ1-2 å‘¨ï¼‰

- [x] å®‰è£… CommunityToolkit.Mvvm
- [ ] ä¿®å¤æ‰€æœ‰ `async void`ï¼ˆæœ€ç´§æ€¥ï¼Œå½±å“ç¨³å®šæ€§ï¼‰
- [ ] æå–å¸¸é‡å’Œå­—ç¬¦ä¸²èµ„æº
- [ ] æ‹†åˆ† `ReviewBatch.cs`

### ç¬¬äºŒé˜¶æ®µï¼šæ¶æ„ä¼˜åŒ–ï¼ˆ2-4 å‘¨ï¼‰

- [ ] å¼•å…¥ DI å®¹å™¨
- [ ] ä¸º Top 5 æœåŠ¡æå–æ¥å£
- [ ] å®ç° IDialogService
- [ ] æ¶ˆé™¤ ViewModel â†’ View ç›´æ¥å¼•ç”¨
- [ ] åˆ›å»ºæµ‹è¯•é¡¹ç›® + é¦–æ‰¹æµ‹è¯•

### ç¬¬ä¸‰é˜¶æ®µï¼šè´¨é‡æå‡ï¼ˆ4-6 å‘¨ï¼‰

- [ ] ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥
- [ ] å¼•å…¥ç»“æ„åŒ–æ—¥å¿—
- [ ] JSON åºåˆ—åŒ–ç»Ÿä¸€
- [ ] å®Œå–„ IDisposable å®ç°
- [ ] æ‰©å……æµ‹è¯•è¦†ç›–ç‡åˆ° 30%+

### ç¬¬å››é˜¶æ®µï¼šæŒç»­æ”¹è¿›

- [ ] ä»£ç å®¡æŸ¥æµç¨‹å»ºç«‹
- [ ] CI ä¸­æ·»åŠ ä»£ç è¦†ç›–ç‡é—¨æ§
- [ ] é€æ­¥å®ç°å›½é™…åŒ–ï¼ˆi18nï¼‰
- [ ] æ€§èƒ½åˆ†æå’Œä¼˜åŒ–
